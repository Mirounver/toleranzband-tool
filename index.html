<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Toleranzbandrechnung Strom ‚Äì N-ERGIE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --ner-red:#ff0000;
  --ner-violet:#710c2f;
  --ner-grey:#565656;
  --ner-grey-light:#f2f2f2;
  --ner-text:#1a1a1a;
}

body{
  margin:0;
  font-family:"Frutiger","Segoe UI","Helvetica Neue",Arial,sans-serif;
  color:var(--ner-text);
  background:#fff;
}

.container{
  max-width:1200px;
  margin:0 auto;
  padding:32px 24px 64px;
}

/* Header */
.header{
  display:flex;
  align-items:center;
  gap:24px;
  border-bottom:3px solid var(--ner-violet);
  padding-bottom:24px;
  margin-bottom:32px;
}
.header img{height:48px}
.header h1{
  margin:0;
  font-size:28px;
  color:var(--ner-violet);
}
.header p{
  margin:6px 0 0;
  font-size:14px;
  color:var(--ner-grey);
}

.section{margin-bottom:40px}
.section h2{
  font-size:20px;
  color:var(--ner-violet);
  margin:0 0 16px;
}

.mode{
  display:flex;
  gap:16px;
}
.mode button{
  padding:10px 18px;
  border:2px solid #ddd;
  background:#fff;
  font-weight:600;
  cursor:pointer;
}
.mode button.active{
  border-color:var(--ner-red);
  color:var(--ner-red);
}

.form{
  max-width:900px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
}
.form-group label{
  display:block;
  font-size:13px;
  color:var(--ner-grey);
  margin-bottom:6px;
}
.form-group input, .form-group select{
  width:100%;
  padding:10px;
  font-size:14px;
  border:1px solid #ccc;
  box-sizing:border-box;
}

.uploadBox{
  max-width:900px;
  border:1px dashed #ccc;
  padding:16px;
  background:#fff;
}
.uploadBox.dragover{
  outline:2px dashed var(--ner-red);
}

.actions{
  margin-top:24px;
  display:flex;
  gap:16px;
}
.actions button{
  padding:12px 20px;
  font-weight:700;
  cursor:pointer;
  border:none;
}
.primary{background:var(--ner-red);color:#fff}
.secondary{background:#e6e6e6}

.result{
  background:var(--ner-grey-light);
  padding:24px;
  max-width:900px;
}
.kpis{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:24px;
}
.kpi span{
  display:block;
  font-size:13px;
  color:var(--ner-grey);
}
.kpi strong{
  font-size:22px;
}

.status{
  margin-top:16px;
  font-weight:700;
}
.status.ok{color:green}
.status.low{color:#0047ab}
.status.high{color:#0047ab}
.status.warn{color:var(--ner-red)}

.notice{
  border-left:4px solid var(--ner-violet);
  padding:12px 16px;
  font-size:13px;
  color:var(--ner-grey);
  max-width:900px;
  margin-top:12px;
}

.loading{
  margin-top:10px;
  font-weight:700;
  color:var(--ner-violet);
  display:none;
}
.input-error{
  border:2px solid var(--ner-red) !important;
}

@media print{

  .mode,
  #panelA,
  #panelB,
  .actions,
  .section h2,
  .section:nth-of-type(1),
  .section:nth-of-type(2)
  {
    display:none !important;
  }

  .pdf-only{
    display:block !important;
  }

  body{
    background:#fff;
  }

  .container{
    max-width:none;
    padding:0;
  }

  .header{
    display:none !important;
  }

  .result{
    background:#fff;
    padding:0;
    max-width:none;
  }

  *{
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .kpis, .kpi, .notice, .status{
    page-break-inside:avoid;
  }

  @page{
    size:A4;
    margin:15mm;
  }
}
</style>
</head>

<body>
<div class="container">
<div class="header">
  <img src="N-ERGIE_LOGO_RGB.png" alt="N-ERGIE">
  <div>
    <h1>Toleranzbandrechnung Strom</h1>
    <p>Berechnung eines angepassten Arbeitspreises auf Basis von Verbrauch und Spotpreis.</p>
  </div>
</div>

<div class="section">
  <h2>1. Eingabeart</h2>
  <div class="mode">
    <button id="modeA" class="active">A: Lastgang</button>
    <button id="modeB">B: Jahresverbrauch + Spotpreis</button>
  </div>
</div>

<div class="section">
  <h2>2. Eingaben</h2>

  <div class="form">
    <div class="form-group">
      <label for="partnerNo">Gesch√§ftspartnernummer (optional)</label>
      <input id="partnerNo" type="text" inputmode="numeric">
    </div>
    <div class="form-group">
      <label for="company">Firma (optional)</label>
      <input id="company" type="text">
    </div>
    <div class="form-group">
      <label for="malo">Marktlokationsnummer (optional)</label>
      <input id="malo" type="text" inputmode="numeric">
    </div>
    <div class="form-group">
      <label for="assetName">Anlagename (optional)</label>
      <input id="assetName" type="text">
    </div>
  </div>

  <div id="panelA" style="margin-top:24px">
    <div class="uploadBox" id="uploadBoxA">
      <div class="form-group" style="margin:0">
        <label for="lastgangFile">Lastgang-Datei hochladen (CSV oder Excel)</label>
        <input type="file" id="lastgangFile" accept=".csv,.xlsx,.xls">
        <small style="display:block;color:#565656;margin-top:6px">
          15-Minuten-Lastgang f√ºr ein vollst√§ndiges Kalenderjahr
        </small>

        <div id="loading" class="loading">Lastgang wird verarbeitet‚Ä¶</div>

        <div id="unitBox" style="display:none; margin-top:12px">
          <label style="display:block;font-size:13px;color:#565656;margin-bottom:6px">
            Einheit des Lastgangs
          </label>
          <select id="unitSelect" style="padding:10px;border:1px solid #ccc;min-width:320px">
            <option value="kWh">kWh (Arbeit je 15 Minuten)</option>
            <option value="kW">kW (Leistung je 15 Minuten)</option>
          </select>
          <small style="display:block;margin-top:6px;color:#565656">
            Automatisch erkannt ‚Äì bitte pr√ºfen.
          </small>
        </div>
      </div>
    </div>
  </div>

  <div id="panelB" style="display:none; margin-top:24px">
    <div class="form">
      <div class="form-group">
        <label for="sumMWh">Jahresverbrauch (MWh) <span style="color:var(--ner-red)">*</span></label>
        <input id="sumMWh" type="number" step="0.01" min="0">
      </div>
      <div class="form-group">
        <label for="spot">Durchschnittlicher Spotpreis (‚Ç¨/MWh) <span style="color:var(--ner-red)">*</span></label>
        <input id="spot" type="number" step="0.01" min="0">
      </div>
    </div>
  </div>

  <div class="form" style="margin-top:24px">
    <div class="form-group">
      <label for="contract">Vertragsmenge (MWh) <span style="color:var(--ner-red)">*</span></label>
      <input id="contract" type="number" step="0.01" min="0">
    </div>
    <div class="form-group">
      <label for="ep">Arbeitspreis EP (‚Ç¨/MWh) <span style="color:var(--ner-red)">*</span></label>
      <input id="ep" type="number" step="0.01" min="0">
    </div>
  </div>

  <div class="actions">
    <button class="primary" id="calc">Berechnen</button>
    <button class="secondary" id="pdf">PDF erstellen</button>
    <button class="secondary" onclick="location.reload()">Zur√ºcksetzen</button>
  </div>
</div>

<div class="section">
  <h2>3. Ergebnis</h2>
  <div class="result">
    <div class="kpis">
      <div class="kpi"><span>Jahresverbrauch</span><strong id="rMWh">‚Äì</strong></div>
      <div class="kpi"><span>Spotpreis</span><strong id="rSpot">‚Äì</strong></div>
      <div class="kpi"><span>Neuer Arbeitspreis</span><strong id="rEP">‚Äì</strong></div>
    </div>

    <div id="status" class="status">Noch keine Berechnung</div>
    <div id="explanation" class="notice" style="display:none"></div>

  </div>
</div>


<div class="notice">
  Hinweis: Modellhafte Berechnung, keine vertraglich verbindliche Abrechnung.
</div>

</div>

<script src="lib/xlsx.full.min.js"></script>
<script src="spotpreise_2025.js"></script>

<script>
const requiredFields = [
  "contract",
  "ep", 
  "sumMWh",
  "spot"     
];
const calcBtn = document.getElementById("calc");
calcBtn.disabled = true;
calcBtn.style.opacity = "0.5";
calcBtn.style.cursor = "not-allowed";

function showWarning(msg){
  const statusEl = document.getElementById("status");
  const explanation = document.getElementById("explanation");
  statusEl.textContent = msg;
  statusEl.className = "status warn";
  if (explanation){
    explanation.style.display = "none";
    explanation.innerHTML = "";
  }
}

function showOkStatus(text, cls){
  const statusEl = document.getElementById("status");
  statusEl.textContent = text;
  statusEl.className = "status " + (cls || "ok");
}

function reqNumber(value){
  const n = Number(value);
  return Number.isFinite(n) && n > 0 ? n : null;
}

function extractMaloFromText(text){
  const s = String(text ?? "");
  const m = s.match(/\b\d{11}\b/);
  return m ? m[0] : null;
}

function setLoading(on){
  const loading = document.getElementById("loading");
  if (!loading) return;
  loading.style.display = on ? "block" : "none";
}
function setCalcEnabled(enabled){
  const btn = document.getElementById("calc");
  btn.disabled = !enabled;
  btn.style.opacity = enabled ? "1" : "0.5";
  btn.style.cursor = enabled ? "pointer" : "not-allowed";
}

function resetStatus(){
  const s = document.getElementById("status");
  const e = document.getElementById("explanation");

  s.textContent = "Noch keine Berechnung";
  s.className = "status";

  if (e){
    e.style.display = "none";
    e.innerHTML = "";
  }
}
function checkModeBReady(){
  if (mode !== "B") return;

  const am = document.getElementById("sumMWh").value;
  const spot = document.getElementById("spot").value;
  const vm = document.getElementById("contract").value;
  const ep = document.getElementById("ep").value;

  const ready =
    am > 0 &&
    spot > 0 &&
    vm > 0 &&
    ep > 0;

  setCalcEnabled(ready);
}
["sumMWh","spot","contract","ep"].forEach(id => {
  const el = document.getElementById(id);
  if (el){
    el.addEventListener("input", checkModeBReady);
  }
});

console.log("Spotjahr:", typeof SPOT_YEAR !== "undefined" ? SPOT_YEAR : "(nicht geladen)");
console.log("Spotpreise Anzahl:", Array.isArray(SPOT_PRICES) ? SPOT_PRICES.length : "(nicht geladen)");

let mode = "A";
const modeABtn = document.getElementById("modeA");
const modeBBtn = document.getElementById("modeB");
const panelA = document.getElementById("panelA");
const panelB = document.getElementById("panelB");

modeABtn.onclick = () => {
  mode = "A";
  panelA.style.display = "";
  panelB.style.display = "none";
  modeABtn.classList.add("active");
  modeBBtn.classList.remove("active");

  resetStatus();
  setCalcEnabled(false);
};

modeBBtn.onclick = () => {
  mode = "B";
  panelB.style.display = "";
  panelA.style.display = "none";
  modeBBtn.classList.add("active");
  modeABtn.classList.remove("active");

  resetStatus();
  setCalcEnabled(false);
  checkModeBReady();
};

const lastgangInput = document.getElementById("lastgangFile");
const uploadBoxA = document.getElementById("uploadBoxA");

if (uploadBoxA && lastgangInput){
  uploadBoxA.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadBoxA.classList.add("dragover");
  });

  uploadBoxA.addEventListener("dragleave", () => {
    uploadBoxA.classList.remove("dragover");
  });

  uploadBoxA.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadBoxA.classList.remove("dragover");

    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      lastgangInput.files = e.dataTransfer.files;
      lastgangInput.dispatchEvent(new Event("change"));
    }
  });
}

document.getElementById("calc").onclick = () => {
document.querySelectorAll(".input-error").forEach(el =>
  el.classList.remove("input-error")
);

let hasError = false;

requiredFields.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;

  if (mode === "A" && (id === "sumMWh" || id === "spot")) return;

  if (!el.value || Number(el.value) <= 0) {
    el.classList.add("input-error");
    hasError = true;
  }
});

if (hasError) {
  showWarning("Bitte alle Pflichtfelder ausf√ºllen.");
  return;
}
  const explanation = document.getElementById("explanation");
  explanation.style.display = "none";
  explanation.innerHTML = "";

  const VM = reqNumber(document.getElementById("contract").value);
  const EP_contract = reqNumber(document.getElementById("ep").value);

  if (!VM || !EP_contract){
    showWarning("Bitte Pflichtfelder ausf√ºllen: Vertragsmenge (MWh) und Arbeitspreis EP (‚Ç¨/MWh).");
    return;
  }

  let AM = null; 
  let Spot = null;

  if (mode === "A"){
    if (!Number.isFinite(window.totalMWh) || !Number.isFinite(window.spotMarketValue)){
      showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
	  setCalcEnabled(false);
      return;
    }
    AM = window.totalMWh;
    Spot = window.spotMarketValue;
  } else {
    AM = reqNumber(document.getElementById("sumMWh").value);
    Spot = reqNumber(document.getElementById("spot").value);

    if (!AM || !Spot){
      showWarning("Bitte Pflichtfelder ausf√ºllen (Option B): Jahresverbrauch (MWh) und Durchschnittlicher Spotpreis (‚Ç¨/MWh).");
      return;
    }
  }

  const TBU = 0.8 * VM;
  const TBO = 1.2 * VM;

  let newEP = EP_contract;
  let cls = "ok";

  if (AM < TBU) {
    newEP = (EP_contract * TBU - 1.1 * Spot * (TBU - AM)) / AM;
    cls = "low";
  } else if (AM > TBO) {
    newEP = (EP_contract * TBO + 0.9 * Spot * (AM - TBO)) / AM;
    cls = "high";
  }

  document.getElementById("rMWh").textContent =
    AM.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " MWh";

  document.getElementById("rSpot").textContent =
    Spot.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " ‚Ç¨/MWh";

  document.getElementById("rEP").textContent =
    newEP.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " ‚Ç¨/MWh";

  const statusText =
    cls === "low"  ? "Unteres Toleranzband unterschritten" :
    cls === "high" ? "Oberes Toleranzband √ºberschritten" :
                     "Verbrauch innerhalb des vereinbarten Toleranzbands";

  showOkStatus(statusText, cls);

  explanation.style.display = "block";
  if (cls === "ok") {
    explanation.innerHTML = `
      <strong>Warum √§ndert sich mein Arbeitspreis nicht?</strong><br>
      Ihr tats√§chlicher Stromverbrauch liegt innerhalb des vertraglich vereinbarten Toleranzbandes (80 % ‚Äì 120 % der Vertragsmenge).
      Daher bleibt der vereinbarte Arbeitspreis unver√§ndert.
    `;
  } else if (cls === "low") {
    explanation.innerHTML = `
      <strong>Warum sinkt mein Arbeitspreis?</strong><br>
      Ihr tats√§chlicher Stromverbrauch liegt unterhalb von 80 % der vertraglich vereinbarten Menge.
      Die Abweichung wird mit dem aktuellen Spotmarktpreis bewertet und gem√§√ü Vertrag verrechnet.
    `;
  } else {
    explanation.innerHTML = `
      <strong>Warum steigt mein Arbeitspreis?</strong><br>
      Ihr tats√§chlicher Stromverbrauch √ºberschreitet 120 % der vertraglich vereinbarten Menge.
      Die Mehrmenge wird mit einem anteiligen Spotmarktpreis bewertet und gem√§√ü Vertrag ber√ºcksichtigt.
    `;
  }
document.querySelector(".result").scrollIntoView({ behavior: "smooth" });
};
document.getElementById("pdf").onclick = () => {
  window.print();
};

if (lastgangInput) {
  lastgangInput.addEventListener("change", () => {
    setLoading(true);

    const file = lastgangInput.files[0];
    if (!file){
      setLoading(false);
      return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
      try{
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        const maloCell = sheet["D3"] ? sheet["D3"].v : null;
        const extractedMalo = extractMaloFromText(maloCell);
        if (extractedMalo){
          document.getElementById("malo").value = extractedMalo;
          console.log("‚úÖ Marktlokationsnummer erkannt (D3):", extractedMalo);
        } else {
          console.log("‚ÑπÔ∏è Keine Marktlokationsnummer in D3 erkannt.");
        }

        const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });

        console.log("Lastgang geladen ‚úÖ");
        console.log("Anzahl Zeilen:", rows.length);

        if (rows.length !== 35040) {
          showWarning("‚ö†Ô∏è Der Lastgang umfasst nicht exakt 35.040 Viertelstundenwerte (Kalenderjahr). Bitte pr√ºfen (Teiljahr / Zeitumstellung / Datenl√ºcken).");
        }

        let consumptionColumn = null;
        let bestScore = -1;

        const sample = rows.slice(10, 300);

        if (!rows[0] || typeof rows[0] !== "object"){
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          return;
        }

        Object.keys(rows[0]).forEach(col => {
          let numericCount = 0;
          let nonZeroCount = 0;

          for (const r of sample) {
            const v = Number(r[col]);
            if (!isNaN(v)) {
              numericCount++;
              if (v !== 0) nonZeroCount++;
            }
          }

          const score = numericCount + nonZeroCount * 2;
          if (score > bestScore) {
            bestScore = score;
            consumptionColumn = col;
          }
        });

        if (!consumptionColumn || bestScore < 50) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        console.log("‚òë Erkannte Verbrauchsspalte:", consumptionColumn);
        window._lastgangRows = rows;
        window._consumptionColumn = consumptionColumn;

        let unit = "kWh";

        for (const r of rows.slice(0, 50)) {
          const a  = String(r["Attribut"] ?? "").toLowerCase();
          const av = String(r["Attributwert"] ?? "").toLowerCase();
          if (a.includes("ma√ü") || a.includes("einheit")) {
            if (av.includes("kwh")) unit = "kWh";
            else if (av.includes("kw")) unit = "kW";
          }
        }

        const colLower = String(consumptionColumn).toLowerCase();
        if (colLower.includes("kwh")) unit = "kWh";
        if (!colLower.includes("kwh") && colLower.includes("kw")) unit = "kW";

        window.detectedUnit = unit;

        const unitBox = document.getElementById("unitBox");
        const unitSelectEl = document.getElementById("unitSelect");
        if (unitBox && unitSelectEl) {
          unitBox.style.display = "block";
          unitSelectEl.value = unit;
          unitSelectEl.onchange = () => recalcFromUnit();
        }

        const selectedUnit = (unitSelectEl && unitSelectEl.value) ? unitSelectEl.value : (window.detectedUnit || "kWh");
        const factor = selectedUnit === "kW" ? 0.25 : 1;

        const consumptionKWh = rows.map((row, index) => {
          const value = Number(row[consumptionColumn]);
          const kWh = value * factor;
          if (isNaN(kWh)) return 0;
          return kWh;
        });

        const negativeCount = consumptionKWh.filter(v => v < 0).length;
        if (negativeCount > 0) {
          showWarning(`‚ö†Ô∏è Es wurden ${negativeCount} negative Verbrauchswerte gefunden. Bitte Lastgang pr√ºfen. (F√ºr sichere Berechnung ggf. Option B nutzen.)`);
        }

        if (!Array.isArray(SPOT_PRICES) || SPOT_PRICES.length === 0) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        if (consumptionKWh.length !== SPOT_PRICES.length) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        const spotCosts = consumptionKWh.map((kWh, i) => (kWh * SPOT_PRICES[i]) / 1000);

        const totalKWh = consumptionKWh.reduce((a, b) => a + b, 0);
        const totalMWh = totalKWh / 1000;

        if (!Number.isFinite(totalMWh) || totalMWh <= 0) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        const totalEuro = spotCosts.reduce((a, b) => a + b, 0);
        const spotMarketValue = totalEuro / totalMWh;

        if (!Number.isFinite(spotMarketValue)) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        if (spotMarketValue < 10 || spotMarketValue > 300) {
          showWarning("‚ö†Ô∏è Der ermittelte Spotmarktwert liegt au√üerhalb typischer Marktbereiche. Bitte Lastgang/Einheit/Spotpreise pr√ºfen. (F√ºr sichere Eingabe ggf. Option B nutzen.)");
        } else {
          showOkStatus("Lastgang erfolgreich verarbeitet. Du kannst jetzt berechnen.", "ok");
		  setCalcEnabled(true);
        }

        window.totalMWh = totalMWh;
        window.spotMarketValue = spotMarketValue;

        setLoading(false);
      } catch (err){
        console.error(err);
        setLoading(false);
        showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		setCalcEnabled(false);
        window.totalMWh = undefined;
        window.spotMarketValue = undefined;
      }
    };

    reader.onerror = () => {
      setLoading(false);
      showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
	  setCalcEnabled(false);
      window.totalMWh = undefined;
      window.spotMarketValue = undefined;
    };

    reader.readAsArrayBuffer(file);
  });
}

function recalcFromUnit() {
  if (!window._lastgangRows || !window._consumptionColumn) return;

  try{
    const unitSelect = document.getElementById("unitSelect");
    const selectedUnit = unitSelect ? unitSelect.value : "kWh";
    const factor = selectedUnit === "kW" ? 0.25 : 1;

    const rows = window._lastgangRows;
    const col = window._consumptionColumn;

    const consumptionKWh = rows.map(r => {
      const v = Number(r[col]);
      return isNaN(v) ? 0 : v * factor;
    });

    if (consumptionKWh.length !== SPOT_PRICES.length){
      showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
	  setCalcEnabled(false);
      window.totalMWh = undefined;
      window.spotMarketValue = undefined;
      return;
    }

    const totalKWh = consumptionKWh.reduce((a,b)=>a+b,0);
    const totalMWh = totalKWh / 1000;

    if (!Number.isFinite(totalMWh) || totalMWh <= 0){
      showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
	  setCalcEnabled(false);
      window.totalMWh = undefined;
      window.spotMarketValue = undefined;
      return;
    }

    const spotCosts = consumptionKWh.map((kWh,i)=> (kWh * SPOT_PRICES[i]) / 1000);
    const totalEuro = spotCosts.reduce((a,b)=>a+b,0);
    const spotMarketValue = totalEuro / totalMWh;

    if (!Number.isFinite(spotMarketValue)){
      showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
	  setCalcEnabled(false);
      window.totalMWh = undefined;
      window.spotMarketValue = undefined;
      return;
    }

    window.totalMWh = totalMWh;
    window.spotMarketValue = spotMarketValue;

    console.log("üîÑ Neu berechnet mit Einheit:", selectedUnit);
    showOkStatus("Lastgang neu berechnet (Einheit ge√§ndert).", "ok");
  } catch (e){
    console.error(e);
    showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
	setCalcEnabled(false);
    window.totalMWh = undefined;
    window.spotMarketValue = undefined;
  }
}
</script>
</body>
</html>
