<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Toleranzbandrechnung Strom – N-ERGIE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --ner-red:#ff0000;
  --ner-violet:#710c2f;
  --ner-grey:#565656;
  --ner-grey-light:#f2f2f2;
  --ner-text:#1a1a1a;
}

body{
  margin:0;
  font-family:"Frutiger","Segoe UI","Helvetica Neue",Arial,sans-serif;
  color:var(--ner-text);
  background:#fff;
}

.container{
  max-width:1000px;
  margin:0 auto;
  padding:40px 24px 80px;
}
.hero{
  text-align:center;
  margin-bottom:60px;
}

.hero img{
  height:60px;
  margin-bottom:24px;
}

.hero h1{
  margin:0;
  font-size:32px;
  color:var(--ner-violet);
  font-weight:700;
}

.hero p{
  margin-top:10px;
  font-size:15px;
  color:var(--ner-grey);
}
.form,
.uploadBox{
  width:100%;
}

.header{
  display:flex;
  flex-direction:column;
  align-items:center;
  text-align:center;

  border-bottom:3px solid var(--ner-violet);
  padding-bottom:24px;
  margin-bottom:32px;
}

.header img{
  height:56px;
  margin-bottom:14px;
}

.header h1{
  margin:0;
  font-size:28px;
  color:var(--ner-violet);
  font-weight:700;
}

.header p{
  margin:8px 0 0;
  font-size:14px;
  color:var(--ner-grey);
  max-width:720px;
}

.section{
  margin-bottom:40px;
}

.section-card{
  background:#fff;
  border-radius:16px;
   padding:32px 36px; 
   box-sizing:border-box;
  box-shadow:0 6px 16px rgba(0,0,0,0.05);
}


.section h2{
  font-size:20px;
  color:var(--ner-violet);
  margin:0 0 16px;
}

.mode{
  display:flex;
  gap:16px;
  justify-content:center;
  margin-top:20px;
}

.mode button{
  padding:12px 22px;
  border-radius:30px;
  border:2px solid #e5e5e5;
  background:#fff;
  font-weight:600;
  cursor:pointer;
  transition:all .2s ease;
}

.mode button.active{
  border-color:var(--ner-red);
  color:#fff;
  background:var(--ner-red);
}

.form{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:32px;
}

.form-group label{
  display:block;
  font-size:13px;
  color:var(--ner-grey);
  margin-bottom:6px;
}
.form-group input,
.form-group select{
  width:100%;
  box-sizing:border-box;
  padding:12px 14px;
  font-size:14px;
  border-radius:8px;
  border:1px solid #ddd;
  transition:all .2s ease;
}

.form-group input:focus,
.form-group select:focus{
  border-color:var(--ner-violet);
  outline:none;
  box-shadow:0 0 0 3px rgba(113,12,47,0.1);
}


.uploadBox{
  width:100%;       
  border:1px dashed #ccc;
  padding:20px;     
  background:#fff;
  border-radius:10px;
  box-sizing:border-box;
   grid-column:1 / -1;   
}
.uploadBox input[type="file"]{
  width:100%;
  box-sizing:border-box;
}

.uploadBox.dragover{
  outline:2px dashed var(--ner-red);
}

.actions{
  margin-top:32px;
  display:flex;
  gap:16px;
  justify-content:center;
}

.actions button{
  padding:12px 20px;
  font-weight:700;
  cursor:pointer;
  border:none;
}
.primary{background:var(--ner-red);color:#fff}
.secondary{background:#e6e6e6}

.result{
  margin-top:10px;
}

.kpis{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:32px;
}
.kpi span{
  display:block;
  font-size:13px;
  color:var(--ner-grey);
}
.kpi strong{
  font-size:22px;
}

.status{
  margin-top:16px;
  font-weight:700;
}
.status.ok{color:#1e8e3e;}  
.status.low{color:#e67e22;}   
.status.high{color:#1f5bd8;}  
.status.warn{color:var(--ner-red)}

.notice{
  border-left:4px solid var(--ner-violet);
  padding:12px 16px;
  font-size:13px;
  color:var(--ner-grey);
  margin-top:12px;
}
.marker-value.low{
  background:#e67e22;
}

.marker-value.ok{
  background:#1e8e3e;
}

.marker-value.high{
  background:#1f5bd8;
}

.loading{
  margin-top:10px;
  font-weight:700;
  color:var(--ner-violet);
  display:none;
}
.input-error{
  border:2px solid var(--ner-red) !important;
}

@media print{

  .mode,
  #panelA,
  #panelB,
  .actions,
  .section h2,
  .section:nth-of-type(1),
  .section:nth-of-type(2)
  {
    display:none !important;
  }

  .pdf-only{
    display:block !important;
  }

  body{
    background:#fff;
  }

  .result{
    background:#fff;
    padding:0;
    max-width:none;
  }

  *{
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  .kpis, .kpi, .notice, .status{
    page-break-inside:avoid;
  }

  @page{
    size:A4;
    margin:15mm;
  }
}


.legend-grid{
  margin-top:8px;
  display:grid;
  gap:8px;
  font-size:13px;
  color:var(--ner-grey);
}

.badge{
  display:inline-block;
  width:10px;
  height:10px;
  border-radius:50%;
  margin-right:8px;
  vertical-align:middle;
}

.formula-text{
  margin-top:8px;
  font-size:13px;
  color:#1a1a1a;
  line-height:1.6;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  white-space: normal;
}

.formula{
  margin-top:16px;
  padding:12px 16px;
  background:#fff;
  border-left:4px solid var(--ner-violet);
  max-width:100%;
}

.eq{ margin-top:10px; }
.eq-row{
  display:flex;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}
.eq-left{
  font-size:18px;
  font-weight:700;
  color:var(--ner-violet);
  white-space:nowrap;
}
.frac{
  display:inline-block;
  text-align:center;
  font-size:18px;
  line-height:1.2;
}
.frac .num{
  padding:0 8px 6px;
  border-bottom:2px solid #111;
  white-space:nowrap;
}
.frac .den{
  padding-top:6px;
  white-space:nowrap;
}

/* Legende */
.legend{
  margin-top:12px;
  padding:12px 16px;
  background:#fff;
  border-left:4px solid var(--ner-violet);
  max-width:100%;
}

.legend-abbr{
  margin-top:10px;
  display:grid;
  gap:6px;
  font-size:13px;
  color:var(--ner-grey);
}

.abbr-row{
  display:grid;
  grid-template-columns: 42px 8px 1fr;
  align-items:baseline;
  column-gap:6px;
}

.abbr-key{
  font-weight:700;
  color:var(--ner-violet);
  white-space:nowrap;
}

.abbr-eq{
  text-align:center;
  color:var(--ner-grey);
  font-weight:700;
}

.abbr-val{
  color:var(--ner-grey);
}
.formula-grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:32px;
  margin-top:12px;
}

.formula-grid div{
  font-size:14px;
}

.band-wrapper{
  margin-top:30px;
}

.band-labels{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  text-align:center;
  font-size:13px;
  color:var(--ner-grey);
  margin-bottom:10px;
}

.band-labels strong{
  display:block;
  font-size:15px;
  color:var(--ner-violet);
}

.band{
  position:relative;
  height:40px;
  display:flex;
  border-radius:6px;
  background:#ddd;
}

.band-segment{
  flex:1;
}

.band-segment.low{
  background:#ffe3cc;
}

.band-segment.mid{
  background:#dff5e6;
}

.band-segment.high{
  background:linear-gradient(
    to right,
    #dbe7ff 0%,
    #dbe7ff 70%,
    rgba(219,231,255,0.2) 100%
  );
}

.band-marker{
  position:absolute;
  top:-4px;
  transform:translateX(-50%);
  text-align:center;
}

.band-marker::after{
  content:"";
  display:block;
  width:2px;
  height:20px;
  background:currentColor;
  margin:4px auto 0;
}

.marker-value{
  display:inline-flex;
  align-items:center;
  justify-content:center;

  min-width:40px;  
  height:30px;  
  padding:0 8px;  
  
  border-radius:20px; 
  font-weight:700;
  font-size:13px;
  color:#fff;
  background:var(--ner-violet);
}

.band-marker.low{ color:#e67e22; }
.band-marker.ok{  color:#1e8e3e; }
.band-marker.high{color:#1f5bd8; }

.band-percent{
  text-align:center;
  margin-top:8px;
  font-size:13px;
  color:var(--ner-grey);
}

.status-card{
  background:#fff;
  border-radius:14px;
  padding:24px;
  margin-bottom:28px;
  box-shadow:0 6px 18px rgba(0,0,0,0.06);
  border-left:6px solid var(--ner-grey);
}
.status-card.low{
  border-left:6px solid #e67e22;
  background:#fff7ef;
}

.status-card.ok{
  border-left:6px solid #1e8e3e;
  background:#eefaf2;
}

.status-card.high{
  border-left:6px solid #1f5bd8;
  background:#eef3ff;
}

.status-title{
  font-size:18px;
  font-weight:700;
  margin-bottom:16px;
}

.status-price span{
  display:block;
  font-size:13px;
  color:var(--ner-grey);
}

.status-price strong{
  font-size:34px;
  color:var(--ner-violet);
}
.percent-badge{
  display:inline-block;
  padding:6px 10px;
  border-radius:20px;
  font-size:14px;
  font-weight:700;
}

.percent-badge.low{
  background:#ffe3cc;
  color:#e67e22;
}

.percent-badge.ok{
  background:#dff5e6;
  color:#1e8e3e;
}

.percent-badge.high{
  background:#dbe7ff;
  color:#1f5bd8;
}

.kpi-cards{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.kpi-card{
  background:#fff;
  border-radius:10px;
  padding:18px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

.kpi-card span{
  font-size:13px;
  color:var(--ner-grey);
  display:block;
  margin-bottom:6px;
}

.kpi-card strong{
  font-size:22px;
}

.band-card{
  background:#fff;
  border-radius:12px;
  padding:22px;
  margin-bottom:28px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

.band-card h3{
  margin-top:0;
  margin-bottom:18px;
  color:var(--ner-violet);
}

.details-card{
  background:#fff;
  border-radius:12px;
  padding:22px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

.details-card h3{
  margin-top:0;
  margin-bottom:16px;
  color:var(--ner-violet);
}

</style>
</head>

<body>
<div class="container">
<div class="header header--center">
  <img src="N-ERGIE_LOGO_RGB.png" alt="N-ERGIE">
  <h1>Toleranzbandrechnung Strom</h1>
  <p>Berechnung eines angepassten Arbeitspreises auf Basis von Verbrauch und Spotpreis.</p>
</div>


<div class="section">
<div class="section-card">
  <h2>1. Eingabeart</h2>
  <div class="mode">
    <button type="button" id="modeA">A: Lastgang importieren</button>
    <button type="button" id="modeB">B: Werte manuell eingeben</button>
  </div>
</div>
</div>


<div class="section">
<div class="section-card">
  <h2>2. Eingaben</h2>

  <div class="form">
    <div class="form-group">
      <label for="partnerNo">Geschäftspartnernummer (optional)</label>
      <input id="partnerNo" type="text" inputmode="numeric">
    </div>
    <div class="form-group">
      <label for="company">Firma (optional)</label>
      <input id="company" type="text">
    </div>
    <div class="form-group">
      <label for="malo">Marktlokationsnummer (optional)</label>
      <input id="malo" type="text" inputmode="numeric">
    </div>
    <div class="form-group">
      <label for="assetName">Anlagename (optional)</label>
      <input id="assetName" type="text">
    </div>
  </div>

  <div id="panelA" style="margin-top:24px">
   <div class="form">
    <div class="uploadBox" id="uploadBoxA">
      <div class="form-group" style="margin:0">
        <label for="lastgangFile">Lastgang-Datei hochladen (CSV oder Excel)</label>
        <input type="file" id="lastgangFile" accept=".csv,.xlsx,.xls">
        <small style="display:block;color:#565656;margin-top:6px">
          15-Minuten-Lastgang für ein vollständiges Kalenderjahr
        </small>

        <div id="loading" class="loading">Lastgang wird verarbeitet…</div>

        <div id="unitBox" style="display:none; margin-top:12px">
          <label style="display:block;font-size:13px;color:#565656;margin-bottom:6px">
            Einheit des Lastgangs
          </label>
          <select id="unitSelect" style="padding:10px;border:1px solid #ccc;min-width:320px">
            <option value="kWh">kWh (Arbeit je 15 Minuten)</option>
            <option value="kW">kW (Leistung je 15 Minuten)</option>
          </select>
          <small style="display:block;margin-top:6px;color:#565656">
            Automatisch erkannt – bitte prüfen.
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

  <div id="panelB" style="display:none; margin-top:24px">
    <div class="form">
      <div class="form-group">
        <label for="sumMWh">Jahresverbrauch (MWh) <span style="color:var(--ner-red)">*</span></label>
        <input id="sumMWh" type="number" step="0.01" min="0">
      </div>
      <div class="form-group">
        <label for="spot">Durchschnittlicher Spotpreis (€/MWh) <span style="color:var(--ner-red)">*</span></label>
        <input id="spot" type="number" step="0.01" min="0">
      </div>
    </div>
  </div>

  <div class="form" style="margin-top:24px">
    <div class="form-group">
      <label for="contract">Vertragsmenge (MWh) <span style="color:var(--ner-red)">*</span></label>
      <input id="contract" type="number" step="0.01" min="0">
    </div>
    <div class="form-group">
      <label for="ep">Arbeitspreis (€/MWh) <span style="color:var(--ner-red)">*</span></label>
      <input id="ep" type="number" step="0.01" min="0">
    </div>
  </div>

  <div class="actions">
    <button class="primary" id="calc">Berechnen</button>
    <button class="secondary" id="pdf">PDF erstellen</button>
    <button class="secondary" onclick="location.reload()">Zurücksetzen</button>
  </div>
</div>
</div>

<div class="section">
<div class="section-card">
  <h2>3. Ergebnis</h2>

  <div class="result">

    <div id="statusCard" class="status-card">
      <div class="status-title" id="statusTitle">
        Noch keine Berechnung
      </div>
      <div class="status-price">
        <span>Neuer Arbeitspreis</span>
        <strong id="rEP">–</strong>
      </div>
    </div>

    <div class="kpi-cards">

      <div class="kpi-card">
        <span>Jahresverbrauch</span>
        <strong id="rMWh">–</strong>
      </div>

      <div class="kpi-card">
        <span>Vertragsmenge</span>
        <strong id="rVM">–</strong>
      </div>

      <div class="kpi-card">
        <span>Spotpreis</span>
        <strong id="rSpot">–</strong>
      </div>

      <div class="kpi-card">
        <span>Verbrauch in %</span>
        <strong id="rPercent" class="percent-badge">–</strong>
      </div>

    </div>

    <div class="band-card">

      <h3>Position im Toleranzband</h3>

      <div class="band-wrapper" id="bandWrapper" style="display:none">

        <div class="band-labels">
          <div>
            <strong id="rangeLow">–</strong>
            <span>Unterhalb (&lt; 80%)</span>
          </div>
          <div>
            <strong id="rangeMid">–</strong>
            <span>Innerhalb (80–120%)</span>
          </div>
          <div>
            <strong id="rangeHigh">–</strong>
            <span>Oberhalb (&gt; 120%)</span>
          </div>
        </div>

        <div class="band">
          <div class="band-segment low"></div>
          <div class="band-segment mid"></div>
          <div class="band-segment high"></div>

          <div class="band-marker" id="bandMarker">
            <div class="marker-value" id="markerValue">–</div>
          </div>
        </div>

        <div class="band-percent" id="percentInfo"></div>

      </div>
    </div>

    <div class="details-card">

      <h3>Details zur Berechnung</h3>

      <div id="explanation" class="notice" style="display:none"></div>

      <div id="formulaBox" class="notice" style="display:none">
        <strong>Verwendete Formel</strong>
        <div class="formula-grid">
          <div id="formulaSymbolic"></div>
          <div id="formulaNumeric"></div>
        </div>
      </div>

      <div id="legend" class="legend">
        <strong>Legende</strong>
        <div class="legend-abbr">
          <div class="abbr-row"><div class="abbr-key">EP<sub>U</sub></div><div class="abbr-eq">=</div><div class="abbr-val">neuer Arbeitspreis bei Unterschreitung</div></div>
          <div class="abbr-row"><div class="abbr-key">EP<sub>O</sub></div><div class="abbr-eq">=</div><div class="abbr-val">neuer Arbeitspreis bei Überschreitung</div></div>
          <div class="abbr-row"><div class="abbr-key">TB<sub>U</sub></div><div class="abbr-eq">=</div><div class="abbr-val">0,8 × Vertragsmenge</div></div>
          <div class="abbr-row"><div class="abbr-key">TB<sub>O</sub></div><div class="abbr-eq">=</div><div class="abbr-val">1,2 × Vertragsmenge</div></div>
          <div class="abbr-row"><div class="abbr-key">EP</div><div class="abbr-eq">=</div><div class="abbr-val">Arbeitspreis</div></div>
          <div class="abbr-row"><div class="abbr-key">AM</div><div class="abbr-eq">=</div><div class="abbr-val">Jahresverbrauch</div></div>
          <div class="abbr-row"><div class="abbr-key">Spot</div><div class="abbr-eq">=</div><div class="abbr-val">durchschnittlicher Spotpreis</div></div>
        </div>
      </div>

    </div>

  </div>
</div>
</div>

<div class="notice">
  Hinweis: Modellhafte Berechnung, keine vertraglich verbindliche Abrechnung.
</div>

</div>

<script src="lib/xlsx.full.min.js"></script>
<script src="spotpreise_2025.js"></script>

<script>
const requiredFieldsA = ["contract","ep"];
const requiredFieldsB = ["contract","ep","sumMWh","spot"];

const calcBtn = document.getElementById("calc");
calcBtn.disabled = true;
calcBtn.style.opacity = "0.5";
calcBtn.style.cursor = "not-allowed";

function showWarning(msg){
  updateStatusCard(msg, "low");
  const explanation = document.getElementById("explanation");
  if (explanation){
    explanation.style.display = "none";
    explanation.innerHTML = "";
  }
}

function showOkStatus(msg){
  const explanation = document.getElementById("explanation");
  explanation.style.display = "block";
  explanation.innerHTML = msg;
}

function updateStatusCard(text, cls){
  const card = document.getElementById("statusCard");
  const title = document.getElementById("statusTitle");
  const price = document.getElementById("rEP");

  title.textContent = text;

  card.classList.remove("low","ok","high","warn");

  if(cls){
    card.classList.add(cls);

    price.style.color =
      cls === "low"  ? "#e67e22" :
      cls === "high" ? "#1f5bd8" :
                       "#1e8e3e";
  }
}

function reqNumber(value){
  const n = Number(value);
  return Number.isFinite(n) && n > 0 ? n : null;
}

function extractMaloFromText(text){
  const s = String(text ?? "");
  const m = s.match(/\b\d{11}\b/);
  return m ? m[0] : null;
}

function setLoading(on){
  const loading = document.getElementById("loading");
  if (!loading) return;
  loading.style.display = on ? "block" : "none";
}
function setCalcEnabled(enabled){
  const btn = document.getElementById("calc");
  btn.disabled = !enabled;
  btn.style.opacity = enabled ? "1" : "0.5";
  btn.style.cursor = enabled ? "pointer" : "not-allowed";
}

function checkModeBReady(){

  const vm = document.getElementById("contract").value;
  const ep = document.getElementById("ep").value;

  if(mode === "A"){
    setCalcEnabled(
      vm > 0 &&
      ep > 0 &&
      Number.isFinite(window.totalMWh) &&
      Number.isFinite(window.spotMarketValue)
    );
    return;
  }

  if(mode === "B"){
    const am = document.getElementById("sumMWh").value;
    const spot = document.getElementById("spot").value;

    setCalcEnabled(
      am > 0 &&
      spot > 0 &&
      vm > 0 &&
      ep > 0
    );
  }
}

["sumMWh","spot","contract","ep"].forEach(id => {
  const el = document.getElementById(id);
  if (el){
    el.addEventListener("input", checkModeBReady);
  }
});

console.log("Spotjahr:", typeof SPOT_YEAR !== "undefined" ? SPOT_YEAR : "(nicht geladen)");
console.log("Spotpreise Anzahl:", Array.isArray(SPOT_PRICES) ? SPOT_PRICES.length : "(nicht geladen)");

let mode = "A";

const modeABtn = document.getElementById("modeA");
const modeBBtn = document.getElementById("modeB");
const panelA = document.getElementById("panelA");
const panelB = document.getElementById("panelB");

modeABtn.classList.add("active");

function clearCommonFields(){
  document.getElementById("contract").value = "";
  document.getElementById("ep").value = "";
}
function clearOptionalFields(){
  document.getElementById("partnerNo").value = "";
  document.getElementById("company").value = "";
  document.getElementById("malo").value = "";
  document.getElementById("assetName").value = "";
}

function clearOptionA(){
  window.totalMWh = undefined;
  window.spotMarketValue = undefined;

  const file = document.getElementById("lastgangFile");
  if (file) file.value = "";

  document.getElementById("unitBox").style.display = "none";
}

function clearOptionB(){
  document.getElementById("sumMWh").value = "";
  document.getElementById("spot").value = "";
}

function resetResult(){

  document.getElementById("rMWh").textContent = "–";
  document.getElementById("rSpot").textContent = "–";
  document.getElementById("rEP").textContent = "–";
  document.getElementById("rVM").textContent = "–";

  updateStatusCard("Noch keine Berechnung", null);

  const explanation = document.getElementById("explanation");
  if (explanation){
    explanation.style.display = "none";
    explanation.innerHTML = "";
  }

  const formulaBox = document.getElementById("formulaBox");
  if (formulaBox){
    formulaBox.style.display = "none";
  }

  const p = document.getElementById("rPercent");
  if (p){
    p.classList.remove("low","ok","high");
    p.textContent = "–";
  }

  const bandWrapper = document.getElementById("bandWrapper");
  if (bandWrapper){
    bandWrapper.style.display = "none";
  }

  const marker = document.getElementById("markerValue");
  const markerWrap = document.getElementById("bandMarker");

  if (marker) marker.textContent = "–";
  if (markerWrap) markerWrap.style.left = "0%";

  const percentInfo = document.getElementById("percentInfo");
  if (percentInfo) percentInfo.textContent = "";

}

modeABtn.onclick = () => {
  mode = "A";
  panelA.style.display = "";
  panelB.style.display = "none";
  modeABtn.classList.add("active");
  modeBBtn.classList.remove("active");

  clearOptionB();
  clearCommonFields();
  clearOptionalFields();

  resetResult();
  setCalcEnabled(false);
};

modeBBtn.onclick = () => {
  mode = "B";
  panelB.style.display = "";
  panelA.style.display = "none";
  modeBBtn.classList.add("active");
  modeABtn.classList.remove("active");

  clearOptionA();
  clearCommonFields();
  clearOptionalFields();

  resetResult();
  setCalcEnabled(false);
};

const lastgangInput = document.getElementById("lastgangFile");
const uploadBoxA = document.getElementById("uploadBoxA");

if (uploadBoxA && lastgangInput){
  uploadBoxA.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadBoxA.classList.add("dragover");
  });

  uploadBoxA.addEventListener("dragleave", () => {
    uploadBoxA.classList.remove("dragover");
  });

  uploadBoxA.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadBoxA.classList.remove("dragover");

    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      lastgangInput.files = e.dataTransfer.files;
      lastgangInput.dispatchEvent(new Event("change"));
    }
  });
}

document.getElementById("calc").onclick = () => {
document.querySelectorAll(".input-error").forEach(el =>
  el.classList.remove("input-error")
);

let hasError = false;
const fields = mode === "A" ? requiredFieldsA : requiredFieldsB;
fields.forEach(id => {
  const el = document.getElementById(id);
  if (!el) return;

  if (mode === "A" && (id === "sumMWh" || id === "spot")) return;

  if (!el.value || Number(el.value) <= 0) {
    el.classList.add("input-error");
    hasError = true;
  }
});

if (hasError) {
  showWarning("Bitte alle Pflichtfelder ausfüllen.");
  return;
}
  const explanation = document.getElementById("explanation");
  explanation.style.display = "none";
  explanation.innerHTML = "";

  const VM = reqNumber(document.getElementById("contract").value);
  const EP_contract = reqNumber(document.getElementById("ep").value);

  if (!VM || !EP_contract){
    showWarning("Bitte Pflichtfelder ausfüllen: Vertragsmenge (MWh) und Arbeitspreis (€/MWh).");
    return;
  }

  let AM = null; 
  let Spot = null;

  if (mode === "A"){
    if (!Number.isFinite(window.totalMWh) || !Number.isFinite(window.spotMarketValue)){
      showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
	  setCalcEnabled(false);
      return;
    }
    AM = window.totalMWh;
    Spot = window.spotMarketValue;
  } else {
    AM = reqNumber(document.getElementById("sumMWh").value);
    Spot = reqNumber(document.getElementById("spot").value);

    if (!AM || !Spot){
      showWarning("Bitte Pflichtfelder ausfüllen (Option B): Jahresverbrauch (MWh) und Durchschnittlicher Spotpreis (€/MWh).");
      return;
    }
  }

  const TBU = 0.8 * VM;
  const TBO = 1.2 * VM;
document.getElementById("rVM").textContent =
  VM.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " MWh";
const percent = (AM / VM) * 100;

document.getElementById("rPercent").textContent =
  percent.toLocaleString("de-DE", { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + " %";

document.getElementById("percentInfo").textContent =
  percent.toLocaleString("de-DE", { minimumFractionDigits: 1, maximumFractionDigits: 1 }) +
  " % der Vertragsmenge";

const lowMax = TBU;
const midMin = TBU;
const midMax = TBO;
const highMin = TBO;

document.getElementById("rangeLow").textContent =
  "< " + lowMax.toLocaleString("de-DE",{maximumFractionDigits:2}) + " MWh";

document.getElementById("rangeMid").textContent =
  midMin.toLocaleString("de-DE",{maximumFractionDigits:2}) +
  " – " +
  midMax.toLocaleString("de-DE",{maximumFractionDigits:2}) +
  " MWh";

document.getElementById("rangeHigh").textContent =
  "> " + highMin.toLocaleString("de-DE",{maximumFractionDigits:2}) + " MWh";

const bandWrapper = document.getElementById("bandWrapper");
if (bandWrapper) bandWrapper.style.display = "block";

const markerValue = document.getElementById("markerValue");
if (markerValue) markerValue.textContent =
  AM.toLocaleString("de-DE",{minimumFractionDigits:2, maximumFractionDigits:2});

let positionPercent;

const BAND_LOW = 33.33;
const BAND_MID = 66.66;
const BAND_HIGH_WIDTH = 33.33;

const MAX_HIGH_FACTOR = 2.0;
const MAX_HIGH_AM = VM * MAX_HIGH_FACTOR;

if (AM < TBU){

  positionPercent = (AM / TBU) * BAND_LOW;

}
else if (AM <= TBO){

  positionPercent =
    BAND_LOW +
    ((AM - TBU) / (TBO - TBU)) * BAND_HIGH_WIDTH;

}
else{

  const spanHigh = MAX_HIGH_AM - TBO;

  const ratioHigh =
    spanHigh > 0
      ? (AM - TBO) / spanHigh
      : 1;

  const clampedRatio = Math.max(0, Math.min(ratioHigh, 1));

  positionPercent =
    BAND_MID +
    clampedRatio * BAND_HIGH_WIDTH;
}

positionPercent = Math.max(0, Math.min(positionPercent, 100));

document.getElementById("bandMarker").style.left =
  positionPercent + "%";

  let newEP = EP_contract;
  let cls = "ok";

  if (AM < TBU) {
    newEP = (EP_contract * TBU - 1.1 * Spot * (TBU - AM)) / AM;
    cls = "low";
  } else if (AM > TBO) {
    newEP = (EP_contract * TBO + 0.9 * Spot * (AM - TBO)) / AM;
    cls = "high";
  }

const percentEl = document.getElementById("rPercent");
if (percentEl){
  percentEl.classList.remove("low","ok","high");
  percentEl.classList.add(cls);
}

  document.getElementById("rMWh").textContent =
    AM.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " MWh";

  document.getElementById("rSpot").textContent =
    Spot.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €/MWh";

  document.getElementById("rEP").textContent =
    newEP.toLocaleString("de-DE", { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €/MWh";

  const statusText =
    cls === "low"  ? "Unteres Toleranzband unterschritten" :
    cls === "high" ? "Oberes Toleranzband überschritten" :
                     "Verbrauch innerhalb des vereinbarten Toleranzbands";

  updateStatusCard(statusText, cls);


explanation.style.display = "block";
if (cls === "ok") {
  explanation.innerHTML = `
    <strong>Warum ändert sich mein Arbeitspreis nicht?</strong><br>
    Ihr tatsächlicher Stromverbrauch liegt innerhalb des vertraglich vereinbarten Toleranzbandes (80 % – 120 % der Vertragsmenge).
    Daher bleibt der vereinbarte Arbeitspreis unverändert.
  `;
} else if (cls === "low") {
  explanation.innerHTML = `
    <strong>Warum sinkt mein Arbeitspreis?</strong><br>
    Ihr tatsächlicher Stromverbrauch liegt unterhalb von 80 % der vertraglich vereinbarten Menge.
    Die Abweichung wird mit dem aktuellen Spotmarktpreis bewertet und gemäß Vertrag verrechnet.
  `;
} else {
  explanation.innerHTML = `
    <strong>Warum steigt mein Arbeitspreis?</strong><br>
    Ihr tatsächlicher Stromverbrauch überschreitet 120 % der vertraglich vereinbarten Menge.
    Die Mehrmenge wird mit einem anteiligen Spotmarktpreis bewertet und gemäß Vertrag berücksichtigt.
  `;
}

const formulaBox = document.getElementById("formulaBox");

if (cls === "low") {
  formulaBox.style.display = "block";

  const TBU = 0.8 * VM;

  document.getElementById("formulaSymbolic").innerHTML = `
    <div class="eq">
      <div class="eq-row">
        <div class="eq-left">EP<sub>U</sub> =</div>
        <div class="frac">
          <div class="num">
            EP × TB<sub>U</sub> − 1,1 × Spot × (TB<sub>U</sub> − AM)
          </div>
          <div class="den">AM</div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("formulaNumeric").innerHTML = `
    <div class="eq">
      <div class="eq-row">
        <div class="eq-left">=</div>
        <div class="frac">
          <div class="num">
            ${EP_contract.toFixed(2)} × ${TBU.toFixed(2)}
            − 1,1 × ${Spot.toFixed(2)} × (${TBU.toFixed(2)} − ${AM.toFixed(2)})
          </div>
          <div class="den">${AM.toFixed(2)}</div>
        </div>
      </div>
    </div>
  `;

} else if (cls === "high") {
  formulaBox.style.display = "block";

  const TBO = 1.2 * VM;

  document.getElementById("formulaSymbolic").innerHTML = `
    <div class="eq">
      <div class="eq-row">
        <div class="eq-left">EP<sub>O</sub> =</div>
        <div class="frac">
          <div class="num">
            EP × TB<sub>O</sub> + 0,9 × Spot × (AM − TB<sub>O</sub>)
          </div>
          <div class="den">AM</div>
        </div>
      </div>
    </div>
  `;

  document.getElementById("formulaNumeric").innerHTML = `
    <div class="eq">
      <div class="eq-row">
        <div class="eq-left">=</div>
        <div class="frac">
          <div class="num">
            ${EP_contract.toFixed(2)} × ${TBO.toFixed(2)}
            + 0,9 × ${Spot.toFixed(2)} × (${AM.toFixed(2)} − ${TBO.toFixed(2)})
          </div>
          <div class="den">${AM.toFixed(2)}</div>
        </div>
      </div>
    </div>
  `;

} else {

  formulaBox.style.display = "block";

  document.getElementById("formulaSymbolic").innerHTML = `
    <div class="eq">
      <div class="eq-row">
        <div class="eq-left">EP =</div>
        <div>EP (keine Anpassung)</div>
      </div>
    </div>
  `;

  document.getElementById("formulaNumeric").innerHTML = `
    <div class="eq">
      <div class="eq-row">
        <div class="eq-left">=</div>
        <div>${EP_contract.toFixed(2)} €/MWh</div>
      </div>
    </div>
  `;
}

const marker = document.getElementById("markerValue");
const markerWrap = document.getElementById("bandMarker");

if (marker && markerWrap){
  marker.className = "marker-value " + cls;
markerWrap.className = "band-marker " + cls;

}

document.querySelector(".result").scrollIntoView({ behavior: "smooth" });
};
document.getElementById("pdf").onclick = () => {
  window.print();
};

if (lastgangInput) {
  lastgangInput.addEventListener("change", () => {
    setLoading(true);

    const file = lastgangInput.files[0];
    if (!file){
      setLoading(false);
      return;
    }

    const reader = new FileReader();

    reader.onload = (e) => {
      try{
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });

        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];

        const maloCell = sheet["D3"] ? sheet["D3"].v : null;
        const extractedMalo = extractMaloFromText(maloCell);
        if (extractedMalo){
          document.getElementById("malo").value = extractedMalo;
          console.log("✅ Marktlokationsnummer erkannt (D3):", extractedMalo);
        } else {
          console.log("ℹ️ Keine Marktlokationsnummer in D3 erkannt.");
        }

        const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });

        console.log("Lastgang geladen ✅");
        console.log("Anzahl Zeilen:", rows.length);

        if (rows.length !== 35040) {
          showWarning("⚠️ Der Lastgang umfasst nicht exakt 35.040 Viertelstundenwerte (Kalenderjahr). Bitte prüfen (Teiljahr / Zeitumstellung / Datenlücken).");
        }

let consumptionColumn = null;
let bestScore = -Infinity;

const sample = rows.slice(20, 500);

function isMonotonicSequence(nums){
  if (nums.length < 10) return false;
  let inc = 0;
  for (let i = 1; i < nums.length; i++){
    if (nums[i] === nums[i-1] + 1) inc++;
  }
  return inc / (nums.length - 1) > 0.9;
}

function looksLikeDate(nums){
  const inRange = nums.filter(n => n >= 30000 && n <= 60000).length;
  return inRange / nums.length > 0.8;
}

Object.keys(rows[0]).forEach(col => {
  const name = String(col).toLowerCase();

  if (
    name.includes("zeile") ||
    name.includes("index") ||
    name.includes("nr") ||
    name.includes("datum") ||
    name.includes("date") ||
    name.includes("zeit") ||
    name.includes("uhr") ||
    name.includes("timestamp")
  ) return;

  const values = sample.map(r => r[col]);
  const nums = values.map(v => Number(v)).filter(n => Number.isFinite(n));

  if (nums.length < 50) return;

  if (looksLikeDate(nums)) return;

  if (isMonotonicSequence(nums)) return;

  let score = 0;

  score += nums.length;

  const mean = nums.reduce((a,b)=>a+b,0) / nums.length;
  const variance = nums.reduce((a,b)=>a + Math.pow(b-mean,2),0) / nums.length;
  score += Math.min(variance, 1e6);

  const zeroRatio = nums.filter(n => n === 0).length / nums.length;
  if (zeroRatio > 0.9) score -= 5000;

  if (name.includes("kwh")) score += 20000;
  if (name.includes("kw") && !name.includes("kwh")) score += 15000;
  if (name.includes("wert")) score += 12000;
  if (name.includes("arbeit")) score += 10000;
  if (name.includes("energie")) score += 10000;
  if (name.includes("lastgang")) score += 8000;

  if (score > bestScore){
    bestScore = score;
    consumptionColumn = col;
  }
});

if (!consumptionColumn){
  setLoading(false);
  showWarning("❌ Keine Verbrauchsspalte erkannt. Bitte Option B verwenden.");
  setCalcEnabled(false);
  window.totalMWh = undefined;
  window.spotMarketValue = undefined;
  return;
}

console.log("☑ Erkannte Verbrauchsspalte:", consumptionColumn);
window._lastgangRows = rows;
window._consumptionColumn = consumptionColumn;


        let unit = "kWh";

        for (const r of rows.slice(0, 50)) {
          const a  = String(r["Attribut"] ?? "").toLowerCase();
          const av = String(r["Attributwert"] ?? "").toLowerCase();
          if (a.includes("maß") || a.includes("einheit")) {
            if (av.includes("kwh")) unit = "kWh";
            else if (av.includes("kw")) unit = "kW";
          }
        }

        const colLower = String(consumptionColumn).toLowerCase();
        if (colLower.includes("kwh")) unit = "kWh";
        if (!colLower.includes("kwh") && colLower.includes("kw")) unit = "kW";

window.detectedUnit = unit;

const unitBox = document.getElementById("unitBox");
const unitSelectEl = document.getElementById("unitSelect");

if (!unitSelectEl){
  showWarning("Einheiten-Auswahlfeld fehlt.");
  setLoading(false);
  return;
}

if (unitBox && unitSelectEl) {
  unitBox.style.display = "block";
  unitSelectEl.value = unit;
  unitSelectEl.onchange = () => recalcFromUnit();
}


        const selectedUnit = (unitSelectEl && unitSelectEl.value) ? unitSelectEl.value : (window.detectedUnit || "kWh");
        const factor = selectedUnit === "kW" ? 0.25 : 1;

        const consumptionKWh = rows.map((row, index) => {
          const value = Number(row[consumptionColumn]);
          const kWh = value * factor;
          if (isNaN(kWh)) return 0;
          return kWh;
        });

        const negativeCount = consumptionKWh.filter(v => v < 0).length;
        if (negativeCount > 0) {
          showWarning(`⚠️ Es wurden ${negativeCount} negative Verbrauchswerte gefunden. Bitte Lastgang prüfen. (Für sichere Berechnung ggf. Option B nutzen.)`);
        }

        if (!Array.isArray(SPOT_PRICES) || SPOT_PRICES.length === 0) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        if (consumptionKWh.length !== SPOT_PRICES.length) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        const spotCosts = consumptionKWh.map((kWh, i) => (kWh * SPOT_PRICES[i]) / 1000);

        const totalKWh = consumptionKWh.reduce((a, b) => a + b, 0);
        const totalMWh = totalKWh / 1000;

        if (!Number.isFinite(totalMWh) || totalMWh <= 0) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        const totalEuro = spotCosts.reduce((a, b) => a + b, 0);
        const spotMarketValue = totalEuro / totalMWh;

        if (!Number.isFinite(spotMarketValue)) {
          setLoading(false);
          showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		  setCalcEnabled(false);
          window.totalMWh = undefined;
          window.spotMarketValue = undefined;
          return;
        }

        if (spotMarketValue < 10 || spotMarketValue > 300) {
          showWarning("⚠️ Der ermittelte Spotmarktwert liegt außerhalb typischer Marktbereiche. Bitte Lastgang/Einheit/Spotpreise prüfen. (Für sichere Eingabe ggf. Option B nutzen.)");
        } else {
          showOkStatus("Lastgang erfolgreich verarbeitet. Du kannst jetzt berechnen.");
		  checkModeBReady();
        }

        window.totalMWh = totalMWh;
        window.spotMarketValue = spotMarketValue;

        setLoading(false);
      } catch (err){
        console.error(err);
        setLoading(false);
        showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
		setCalcEnabled(false);
        window.totalMWh = undefined;
        window.spotMarketValue = undefined;
      }
    };

    reader.onerror = () => {
      setLoading(false);
      showWarning("Lastgang konnte nicht sicher erkannt/ausgewertet werden. Bitte Option B verwenden und Jahresverbrauch + Spotpreis manuell eintragen.");
	  setCalcEnabled(false);
      window.totalMWh = undefined;
      window.spotMarketValue = undefined;
    };

    reader.readAsArrayBuffer(file);
  });
}

function recalcFromUnit() {
  if (!window._lastgangRows || !window._consumptionColumn) return;

  try{
    const unitSelect = document.getElementById("unitSelect");
    const selectedUnit = unitSelect ? unitSelect.value : "kWh";

    const intervalMinutes = window._intervalMinutes || 15;
    const factor = selectedUnit === "kW"
      ? (intervalMinutes / 60)
      : 1;

    const rows = window._lastgangRows;
    const col = window._consumptionColumn;

    const consumptionKWh = rows.map(r => {
      const v = Number(r[col]);
      return Number.isFinite(v) ? v * factor : 0;
    });

    if (!Array.isArray(SPOT_PRICES) || SPOT_PRICES.length !== consumptionKWh.length){
      showWarning("Spotpreislänge passt nicht zum Lastgang.");
      return;
    }

    const spotCosts = consumptionKWh.map((kWh,i)=>(kWh * SPOT_PRICES[i]) / 1000);

    const totalKWh = consumptionKWh.reduce((a,b)=>a+b,0);
    const totalMWh = totalKWh / 1000;
    const totalEuro = spotCosts.reduce((a,b)=>a+b,0);
    const spotMarketValue = totalEuro / totalMWh;

    window.totalMWh = totalMWh;
    window.spotMarketValue = spotMarketValue;

    showOkStatus("Einheit geändert – Werte neu berechnet.");
    checkModeBReady();

  } catch(err){
    console.error(err);
    showWarning("Neuberechnung nach Einheitenwechsel fehlgeschlagen.");
  }
}
</script>
</body>
</html>


